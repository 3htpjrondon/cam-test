-- =================================================================
-- Copyright 2018 IBM Corporation
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
-- http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.
-- =================================================================

--                                                                   
-- ***************************************************************** 
-- IBM Content Navigator configuration table creation script
-- for DB2 LUW
-- *****************************************************************

-- Connect to db
CONNECT TO <%=@CPEDB_NAME %>;
 
--  Create a schema for the application to use
CREATE SCHEMA <%=@CPEDB_ICNDB_SCHEMA %> AUTHORIZATION <%=@DB2_USER %>;
-- Comments on the above statement. This is for sync. If the user who
-- creating the schema is the same as the one specified in db2inst1
-- this turns out to be a noop (the user who creates an object is already
-- authorized. This is generally the case in CMUI. If someone is manually
-- installing this, they *could* specify a different user. For sync, that
-- user must be able to create/drop tables in the schema for sync. The
-- 'AUTHORIZATION' directive accomplishes just that.
-- *****************************************************************
--  Create buffer pools and tablespaces for the application to use
CREATE Bufferpool <%=@CPEDB_ICNDB_TSICN %>BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_ICNDB_TSICN %>TEMPBP IMMEDIATE SIZE 200 PAGESIZE 32K;
CREATE REGULAR TABLESPACE <%=@CPEDB_ICNDB_TSICN %> PAGESIZE 32 K 
	MANAGED BY AUTOMATIC STORAGE AUTORESIZE YES INITIALSIZE 20 M 
	INCREASESIZE 20 M BUFFERPOOL <%=@CPEDB_ICNDB_TSICN %>BP;
CREATE USER TEMPORARY TABLESPACE <%=@CPEDB_ICNDB_TSICN %>TEMP PAGESIZE 32K 
	MANAGED BY AUTOMATIC STORAGE BUFFERPOOL <%=@CPEDB_ICNDB_TSICN %>TEMPBP;
-- *****************************************************************

-- Close connection
CONNECT RESET;

-- Connect to db
CONNECT TO <%=@CPEDB_NAME %>;

-- Create Schema
CREATE SCHEMA <%=@CPEDB_TOSDB_SCHEMA %>;
SET SCHEMA <%=@CPEDB_TOSDB_SCHEMA %>;

-- Create 256MB GCD buffer pool
CREATE Bufferpool <%=@CPEDB_TOSDB_SCHEMA %>_DATA_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_TOSDB_SCHEMA %>_INDX_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;

-- Create additional buffer pools
CREATE Bufferpool <%=@CPEDB_TOSDB_SCHEMA %>_LOB_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_TOSDB_SCHEMA %>_TEMP_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_TOSDB_SCHEMA %>_SYS_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;

CREATE STOGROUP <%=@CPEDB_TOSDB_SCHEMA %>DATA_SG ON '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_TOSDB_SCHEMA %>/datafs1', '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_TOSDB_SCHEMA %>/datafs2', '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_TOSDB_SCHEMA %>/datafs3';
CREATE STOGROUP <%=@CPEDB_TOSDB_SCHEMA %>INDX_SG ON '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_TOSDB_SCHEMA %>/indexfs1', '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_TOSDB_SCHEMA %>/indexfs2';
CREATE STOGROUP <%=@CPEDB_TOSDB_SCHEMA %>LOB_SG ON '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_TOSDB_SCHEMA %>/lobfs1';

-- Create tablespaces
CREATE LARGE TABLESPACE <%=@CPEDB_TOSDB_TSTOSDATA %> PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
USING STOGROUP <%=@CPEDB_TOSDB_SCHEMA %>DATA_SG
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_TOSDB_SCHEMA %>_DATA_BP DROPPED TABLE RECOVERY ON;

CREATE LARGE TABLESPACE <%=@CPEDB_TOSDB_TSTOSIDX %> PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
USING STOGROUP <%=@CPEDB_TOSDB_SCHEMA %>INDX_SG
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_TOSDB_SCHEMA %>_INDX_BP DROPPED TABLE RECOVERY ON;

CREATE LARGE TABLESPACE <%=@CPEDB_TOSDB_TSTOSLOB %> PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
USING STOGROUP <%=@CPEDB_TOSDB_SCHEMA %>LOB_SG
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_TOSDB_SCHEMA %>_LOB_BP DROPPED TABLE RECOVERY ON;

CREATE USER TEMPORARY TABLESPACE <%=@CPEDB_TOSDB_SCHEMA %>_TEMP_TS PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_TOSDB_SCHEMA %>_TEMP_BP;

CREATE SYSTEM TEMPORARY TABLESPACE <%=@CPEDB_TOSDB_SCHEMA %>_SYSTMP_TS PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_TOSDB_SCHEMA %>_SYS_BP;

-- GRANT USE OF TABLESPACE <%=@CPEDB_TOSDB_TSTOSDATA %> TO user <%=@DB2_USER %>;
-- GRANT USE OF TABLESPACE <%=@CPEDB_TOSDB_TSTOSIDX %> TO user <%=@DB2_USER %>;
-- GRANT USE OF TABLESPACE <%=@CPEDB_TOSDB_TSTOSLOB %> TO user <%=@DB2_USER %>;
-- GRANT USE OF TABLESPACE <%=@CPEDB_TOSDB_SCHEMA %>_TEMP_TS TO user <%=@DB2_USER %>;

---- GRANT IMPLICIT_SCHEMA ON DATABASE TO user db2admin;


-- Optionally, grant GROUP access to tablespaces
-- -- GRANT CREATETAB,CONNECT ON DATABASE  TO GROUP DB2USERS;
-- -- GRANT USE OF TABLESPACE USERTEMP1 TO GROUP DB2USERS;
-- -- GRANT USE OF TABLESPACE USERSPACE1 TO GROUP DB2USERS;

-- Close connection
CONNECT RESET;

-- Connect to db
CONNECT TO <%=@CPEDB_NAME %>;

-- Create Schema
CREATE SCHEMA <%=@CPEDB_DOSDB_SCHEMA %>;
SET SCHEMA <%=@CPEDB_DOSDB_SCHEMA %>;

-- Create 256MB GCD buffer pool
CREATE Bufferpool <%=@CPEDB_DOSDB_SCHEMA %>_DATA_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_DOSDB_SCHEMA %>_INDX_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;

-- Create additional buffer pools
CREATE Bufferpool <%=@CPEDB_DOSDB_SCHEMA %>_LOB_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_DOSDB_SCHEMA %>_TEMP_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;
CREATE Bufferpool <%=@CPEDB_DOSDB_SCHEMA %>_SYS_BP IMMEDIATE SIZE AUTOMATIC PAGESIZE 32K;

CREATE STOGROUP <%=@CPEDB_DOSDB_SCHEMA %>DATA_SG ON '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_DOSDB_SCHEMA %>/datafs1', '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_DOSDB_SCHEMA %>/datafs2', '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_DOSDB_SCHEMA %>/datafs3';
CREATE STOGROUP <%=@CPEDB_DOSDB_SCHEMA %>INDX_SG ON '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_DOSDB_SCHEMA %>/indexfs1', '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_DOSDB_SCHEMA %>/indexfs2';
CREATE STOGROUP <%=@CPEDB_DOSDB_SCHEMA %>LOB_SG ON '<%=@DB2_DATA_DIR %>/<%=@CPEDB_NAME %>/<%=@CPEDB_DOSDB_SCHEMA %>/lobfs1';

-- Create tablespaces
CREATE LARGE TABLESPACE <%=@CPEDB_DOSDB_TSDOSDATA %> PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
USING STOGROUP <%=@CPEDB_DOSDB_SCHEMA %>DATA_SG
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_DOSDB_SCHEMA %>_DATA_BP DROPPED TABLE RECOVERY ON;

CREATE LARGE TABLESPACE <%=@CPEDB_DOSDB_TSDOSIDX %> PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
USING STOGROUP <%=@CPEDB_DOSDB_SCHEMA %>INDX_SG
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_DOSDB_SCHEMA %>_INDX_BP DROPPED TABLE RECOVERY ON;

CREATE LARGE TABLESPACE <%=@CPEDB_DOSDB_TSDOSDLOB %> PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
USING STOGROUP <%=@CPEDB_DOSDB_SCHEMA %>LOB_SG
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_DOSDB_SCHEMA %>_LOB_BP DROPPED TABLE RECOVERY ON;

CREATE USER TEMPORARY TABLESPACE <%=@CPEDB_DOSDB_SCHEMA %>_TEMP_TS PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_DOSDB_SCHEMA %>_TEMP_BP;

CREATE SYSTEM TEMPORARY TABLESPACE <%=@CPEDB_DOSDB_SCHEMA %>_SYSTMP_TS PAGESIZE 32 K
MANAGED BY AUTOMATIC STORAGE
EXTENTSIZE 16 OVERHEAD 10.5 PREFETCHSIZE 16 TRANSFERRATE 0.14
BUFFERPOOL <%=@CPEDB_DOSDB_SCHEMA %>_SYS_BP;

-- GRANT USE OF TABLESPACE <%=@CPEDB_DOSDB_TSDOSDATA %> TO user <%=@DB2_USER %>;
-- GRANT USE OF TABLESPACE <%=@CPEDB_DOSDB_TSDOSIDX %> TO user <%=@DB2_USER %>;
-- GRANT USE OF TABLESPACE <%=@CPEDB_DOSDB_TSDOSDLOB %> TO user <%=@DB2_USER %>;
-- GRANT USE OF TABLESPACE <%=@CPEDB_DOSDB_SCHEMA %>_TEMP_TS TO user <%=@DB2_USER %>;

---- GRANT IMPLICIT_SCHEMA ON DATABASE TO user db2admin;


-- Optionally, grant GROUP access to tablespaces
-- -- GRANT CREATETAB,CONNECT ON DATABASE  TO GROUP DB2USERS;
-- -- GRANT USE OF TABLESPACE USERTEMP1 TO GROUP DB2USERS;
-- -- GRANT USE OF TABLESPACE USERSPACE1 TO GROUP DB2USERS;

-- Close connection
CONNECT RESET;
